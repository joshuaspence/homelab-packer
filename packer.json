{
  "builders": [
    {
      "type": "arm-image",
      "iso_url": "{{user `iso_url`}}",
      "iso_checksum_url": "{{user `iso_url`}}.sha256",
      "iso_checksum_type": "sha256",
      "output_directory": "build",
      "target_image_size": "{{user `target_image_size`}}"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "# Upgrade system packages",
        "apt-get update",
        "apt-get --yes upgrade",
        "apt-get --yes dist-upgrade",
        "apt-get --yes auto-remove",
        "apt-get clean"
      ],
      "environment_vars": [
        "LANG=",
        "LANGUAGE="
      ]
    },
    {
      "type": "shell",
      "inline": [
        "# Change timezone",
        "test -f /usr/share/zoneinfo/{{user `timezone`}}",
        "ln --force --symbolic /usr/share/zoneinfo/{{user `timezone`}} /etc/localtime",
        "echo {{user `timezone`}} > /etc/timezone",
        "dpkg-reconfigure --frontend noninteractive tzdata"
      ],
      "environment_vars": [
        "LANG=",
        "LANGUAGE="
      ]
    },
    {
      "type": "shell",
      "inline": [
        "# Enable SSH",
        "touch /boot/ssh"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "# Configure Wi-Fi",
        "wpa_passphrase '{{user `wifi_name`}}' '{{user `wifi_password`}}' >> /etc/wpa_supplicant/wpa_supplicant.conf"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "# Install Docker",
        "curl --fail --location --show-error --silent https://get.docker.com | sh",
        "usermod --append --groups docker pi"
      ],
      "environment_vars": [
        "LANG=",
        "LANGUAGE="
      ]
    },
    {
      "type": "shell",
      "inline": [
        "# Install Kubernetes",
        "curl --fail --show-error --silent https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -",
        "echo 'deb https://apt.kubernetes.io/ kubernetes-xenial main' > /etc/apt/sources.list.d/kubernetes.list",
        "apt-get update",
        "apt-get --yes install --no-install-recommends kubeadm kubectl"
      ]
    },



    {
      "type": "shell",
      "inline": [
        "# Disable swap",
        "dphys-swapfile swapoff",
        "dphys-swapfile uninstall",
        "systemctl disable dphys-swapfile",

        "# Enable cgroups",
        "sed --expression 's/$/ cgroup_enable=cpuset cgroup_enable=memory/' --in-place /boot/cmdline.txt"
      ]
    }
  ],
  "variables": {
    "iso_url": "https://downloads.raspberrypi.org/raspbian_lite/images/raspbian_lite-2019-07-12/2019-07-10-raspbian-buster-lite.zip",
    "target_image_size": "34359738368",
    "timezone": "Australia/Sydney",
    "wifi_name": null,
    "wifi_password": null
  },
  "sensitive-variables": ["wifi_password"]
}
