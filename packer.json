{
  "builders": [
    {
      "type": "arm-image",
      "iso_url": "{{user `iso_url`}}",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "sha256",
      "output_directory": "build",
      "target_image_size": "{{user `target_image_size`}}"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "apt-get --quiet update",
        "apt-get --quiet --yes upgrade",
        "apt-get --quiet --yes dist-upgrade",
        "apt-get --quiet clean"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "test -f /usr/share/zoneinfo/{{user `timezone`}}",
        "timedatectl set-timezone '{{user `timezone`}}'"
      ]
    },
    {
      "type": "shell",
      "inline": ["touch /boot/ssh"]
    },
    {
      "type": "shell",
      "inline": ["wpa_passphrase '{{user `wifi_name`}}' '{{user `wifi_password`}}' >> /etc/wpa_supplicant/wpa_supplicant.conf"]
    },




    {
      "type": "shell",
      "inline": [
        "curl --location --show-error --silent https://get.docker.com | sh",
        "usermod --append --groups docker pi"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "# Installing Kubernetes",
        "curl --silent https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -",
        "echo 'deb https://apt.kubernetes.io/ kubernetes-xenial main' > /etc/apt/sources.list.d/kubernetes.list",
        "apt-get --quiet update",
        "apt-get --quiet --yes install kubeadm kubectl",

        "# Disable swap",
        "dphys-swapfile swapoff",
        "dphys-swapfile uninstall",
        "systemctl disable dphys-swapfile",

        "# Enable cgroups",
        "sed --expression 's/$/ cgroup_enable=cpuset cgroup_enable=memory/' --in-place /boot/cmdline.txt"
      ]
    },




    {
      "type": "file",
      "source": "{{user `ssh_authorized_keys_path`}}",
      "destination": "/home/pi/.ssh/authorized_keys"
    },
    {
      "type": "shell",
      "inline": [
        "sed '/PasswordAuthentication/d' -i /etc/ssh/ssh_config",
        "echo >> /etc/ssh/ssh_config",
        "echo 'PasswordAuthentication no' >> /etc/ssh/ssh_config"
      ]
    },
    {
      "type": "shell",
      "inline": ["hostnamectl set-hostname '{{user `hostname`}}'"]
    }
  ],
  "variables": {
    "hostname": "raspberrypi",
    "iso_checksum": "9e5cf24ce483bb96e7736ea75ca422e3560e7b455eee63dd28f66fa1825db70e",
    "iso_url": "https://downloads.raspberrypi.org/raspbian_lite/images/raspbian_lite-2019-07-12/2019-07-10-raspbian-buster-lite.zip",
    "ssh_authorized_keys_path": null,
    "target_image_size": "34359738368",
    "timezone": "Australia/Sydney",
    "wifi_name": null,
    "wifi_password": null
  },
  "sensitive-variables": ["wifi_password"]
}
