---
name: 'Lint'
on:
  pull_request: {}
  push: {}
  schedule:
    - cron: '0 0 * * 1'
jobs:
  # TODO: Use `packer init` when the plugin supports it, see
  # https://github.com/solo-io/packer-builder-arm-image/pull/95.
  _builder:
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'actions/checkout@v2'
        with:
          repository: 'solo-io/packer-builder-arm-image'
      - id: 'repository'
        run: 'echo "::set-output name=sha::$(git rev-parse HEAD)"'
      - id: 'cache'
        uses: 'actions/cache@v2'
        with:
          path: 'packer-builder-arm-image'
          key: 'packer-builder-arm-image-${{ steps.repository.outputs.sha }}'
      - if: 'steps.cache.outputs.cache-hit != ''true'''
        uses: 'actions/setup-go@v2'
        with:
          go-version: '1.16'
      - if: 'steps.cache.outputs.cache-hit != ''true'''
        run: 'go build'
        env:
          CGO_ENABLED: 0
      - uses: 'actions/upload-artifact@v2'
        with:
          name: 'packer-builder-arm-image'
          path: 'packer-builder-arm-image'
          if-no-files-found: 'error'

  packer-fmt:
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'actions/checkout@v2'
      - uses: 'hashicorp-contrib/setup-packer@v1.0.0'
      - run: 'packer fmt -check .'

  packer-validate:
    needs: '_builder'
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'actions/checkout@v2'

      - uses: 'hashicorp-contrib/setup-packer@v1.0.0'
      - uses: 'actions/download-artifact@v2'
        with:
          name: 'packer-builder-arm-image'
          path: '~/.packer.d/plugins'
      - run: 'chmod +x ~/.packer.d/plugins/packer-builder-arm-image'
      - run: 'sudo apt-get install qemu-user-static'

      - run: 'packer validate .'

  shellcheck:
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'actions/checkout@v2'
      - uses: 'ludeeus/action-shellcheck@1.1.0'

  yamllint:
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'actions/checkout@v2'
      - uses: 'ibiqlik/action-yamllint@v3'
