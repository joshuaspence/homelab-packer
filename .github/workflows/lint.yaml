---
name: 'Lint'
on:
  - 'pull_request'
  - 'push'
jobs:
  # TODO: Use `packer init` when the plugin supports it, see
  # https://github.com/solo-io/packer-builder-arm-image/pull/95.
  _builder:
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'actions/checkout@v2'
        with:
          repository: 'solo-io/packer-builder-arm-image'
      - id: 'repository'
        run: 'echo "::set-output name=sha::$(git rev-parse HEAD)"'
      - id: 'cache'
        uses: 'actions/cache@v2'
        with:
          path: 'packer-builder-arm-image'
          key: 'builder-${{ steps.repository.outputs.sha }}'
      - if: 'steps.cache.outputs.cache-hit != ''true'''
        uses: 'actions/setup-go@v2'
        with:
          go-version: '1.16'
      - if: 'steps.cache.outputs.cache-hit != ''true'''
        run: 'go build'
      - uses: 'actions/upload-artifact@v2'
        with:
          name: 'packer-builder-arm-image'
          path: 'packer-builder-arm-image'
          if-no-files-found: 'error'

  packer-fmt:
    runs-on: 'ubuntu-latest'
    container: 'hashicorp/packer:latest'
    steps:
      - uses: 'actions/checkout@v2'
      - run: 'packer fmt -check .'

  packer-validate:
    needs: '_builder'
    runs-on: 'ubuntu-latest'
    container: 'hashicorp/packer:latest'
    steps:
      - uses: 'actions/checkout@v2'
      - uses: 'actions/download-artifact@v2'
        with:
          name: 'packer-builder-arm-image'
          path: '~/.packer.d/plugins'
      - run: 'chmod +x ~/.packer.d/plugins/packer-builder-arm-image'
      - run: 'apk add qemu-arm'
      - run: 'packer validate -var qemu_binary=qemu-arm .'

  yamllint:
    runs-on: 'ubuntu-latest'
    steps:
      - uses: 'actions/checkout@v2'
      - uses: 'ibiqlik/action-yamllint@v3'
